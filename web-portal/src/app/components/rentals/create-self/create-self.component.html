<section class="create-section" *transloco="let t; prefix: 'rentals.createSelf'">
  <span style="display: none">{{ billingPlanLogic$ | async }}</span>

  <div class="main-content">
    <form [formGroup]="formGroup" (ngSubmit)="register()">
      <h2>{{ t('card.title') }}</h2>
      <hr class="bar" />

      <div class="card-content">
        <span class="full-width" style="color: var(--clr-text-muted); margin-bottom: 1rem">
          {{ t('card.subtitle') }}
        </span>

        <h3 class="full-width">{{ t('card.section.vehicle') }}</h3>
        <div class="form-field full-width">
          @if (vehicle$ | async; as vehicle) {
            <div class="vehicle-summary">
              <div class="vehicle-icon">
                <span class="material-icons">directions_car</span>
              </div>

              <div class="vehicle-info">
                <h4>{{ vehicle.brand }} {{ vehicle.model }}</h4>
                <span class="license-plate">{{ vehicle.licensePlate }}</span>

                <div class="vehicle-tags">
                  <span class="badge group">{{ vehicle.group.name }}</span>
                  <span class="badge">{{ vehicle.fuelType }}</span>
                  <span class="badge">{{ vehicle.year }}</span>
                  <span class="badge">Km: {{ vehicle.kilometers }}</span>
                </div>
              </div>
            </div>
          } @else {
            <div class="vehicle-summary" style="opacity: 0.5">
              <span>{{ t('home.loading') }}</span>
            </div>
          }
          <input type="hidden" formControlName="vehicleId" />
        </div>

        <h3 class="full-width">{{ t('card.section.driver') }}</h3>
        <div class="form-field full-width">
          <label>{{ t('card.label.driver') }}</label>
          <select class="form-input" formControlName="driverId">
            <option [ngValue]="null" disabled>{{ t('card.placeholder.driver') }}</option>
            @for (driver of drivers$ | async; track driver.id) {
              <option [ngValue]="driver.id">{{ driver.fullName }}</option>
            }
          </select>
          @if (driverId?.errors?.['required'] && driverId?.touched) {
            <span class="error-message">{{ t('card.errors.driverRequired') }}</span>
          }
        </div>

        <h3 class="full-width">{{ t('card.section.datesAndPlan') }}</h3>
        <div class="form-row full-width">
          <div class="form-field">
            <label>{{ t('card.label.startDate') }}</label>
            <input class="form-input" formControlName="startDate" type="date" />
            @if (startDate?.errors?.['required'] && startDate?.touched) {
              <span class="error-message">{{ t('card.errors.startDateRequired') }}</span>
            }
          </div>

          <div class="form-field">
            <label>{{ t('card.label.expectedReturnDate') }}</label>
            <input class="form-input" formControlName="expectedReturnDate" type="date" />
            @if (expectedReturnDate?.errors?.['required'] && expectedReturnDate?.touched) {
              <span class="error-message">{{ t('card.errors.expectedReturnDateRequired') }}</span>
            }
          </div>
        </div>

        <div class="form-field full-width">
          <label>{{ t('card.label.billingPlanType') }}</label>
          <select class="form-input" formControlName="billingPlanType">
            <option [ngValue]="null" disabled>{{ t('card.placeholder.billingPlanType') }}</option>
            <option value="Daily">{{ t('card.plan.daily') }}</option>
            <option value="Controlled">{{ t('card.plan.controlled') }}</option>
            <option value="Free">{{ t('card.plan.free') }}</option>
          </select>
          @if (billingPlanType?.errors?.['required'] && billingPlanType?.touched) {
            <span class="error-message">{{ t('card.errors.billingPlanTypeRequired') }}</span>
          }
        </div>

        @if (billingPlanType?.value === 'Controlled') {
          <div class="form-field full-width">
            <label>{{ t('card.label.estimatedKilometers') }}</label>
            <input
              class="form-input"
              formControlName="estimatedKilometers"
              type="number"
              [placeholder]="t('card.placeholder.estimatedKilometers')"
            />
            @if (estimatedKilometers?.errors?.['required'] && estimatedKilometers?.touched) {
              <span class="error-message">{{ t('card.errors.estimatedKilometersRequired') }}</span>
            }
          </div>
        }

        @if ({ hasCoupon: hasCoupon$ | async, hasExtras: hasExtras$ | async }; as state) {
          @if (state.hasCoupon || state.hasExtras) {
            <h3 class="full-width">{{ t('card.section.extras') }}</h3>
          }

          @if (state.hasCoupon) {
            <div class="form-field full-width">
              <label>{{ t('card.label.coupon') }}</label>
              <select class="form-input" formControlName="couponId">
                <option [ngValue]="null">{{ t('card.placeholder.coupon') }}</option>

                @for (coupon of coupons$ | async; track coupon.id) {
                  <option [ngValue]="coupon.id">
                    {{ coupon.name }}
                    @if (coupon.discountValue) {
                      (-{{ coupon.discountValue | currency: 'BRL' }})
                    }
                  </option>
                }
              </select>
            </div>
          } @else if (state.hasExtras) {}

          @if (state.hasExtras) {
            <div class="form-field full-width">
              <label>{{ t('card.label.extras') }}</label>
              <select class="form-input" formControlName="rentalRentalExtrasIds" multiple>
                @for (extra of extras$ | async; track extra.id) {
                  <option [value]="extra.id">
                    {{ extra.name }} ({{ extra.price | currency: 'BRL' : 'symbol' : '1.2-2' }})
                  </option>
                }
              </select>
              <small class="helper-text">{{ t('card.helper.multiSelect') }}</small>
            </div>
          } @else if (state.hasCoupon) {}
        } @else {
          <div class="info-message full-width">
            {{ t('card.warnings.noOptionsAvailable') }}
          </div>
        }
      </div>

      <div class="buttons">
        <gs-buttons
          [buttonType]="buttonType.Link"
          [text]="t('card.buttons.back')"
          routerLink="/home"
        ></gs-buttons>

        <gs-buttons
          [buttonType]="buttonType.Default"
          [text]="t('card.buttons.confirm')"
          type="submit"
          [disabled]="formGroup.invalid"
          (click)="register()"
        ></gs-buttons>
      </div>
    </form>
  </div>
</section>
